---
title: "Bayesian Linear Analysis"
author: "Megan Feddern"
date: "2023-05-08"
output:
  html_document: 
    toc: true
    toc_depth: 4
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(nord)
library(tidyr)
library(lubridate)
library(readr)
library(stringr)
library(ggplot2)
library(cowplot)
library(Cairo)
library(MCMCvis)
library(HDInterval)
library(reshape2)
library(tidyverse)
library(dplyr)
library(rstan)
library(here)
library(PNWColors)
library(maps)       #basic mapping functions and some data
library(mapdata)    #some additional hires data
library(maptools)   #useful tools such as reading shapefiles
library(mapproj)
library(rgdal)
library(colorspace)
library(PBSmapping) #powerful mapping functions developed by Pacific Biological Station
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(loo)

```

**Changes since Meeting**
- Tested covariance of station 51N; included in GoA not northern CC
- PDO is unstandardized
- Upwelling is standardized across entire time period (1967 - 2022), within region and within season (for the seasonal models - annaual model is not)
- Tested model using seasonal averages instead of monthly means across season. *I think this is the better approach*
- Added a lagged year variable so the months of Nov and Dec are included with the correct Jan - Mar values for winter
-Added NPGO analysis
-Tested an era based model and compared to a no era model with looic to compare model performance
-Altered distributions, added SCC to the data according to the map

Mapping Bakun Index locations with the regions we have identified

```{r map, include=FALSE}

here::i_am("Output/BayesianLinearModels.Rmd")
col2<-pnw_palette("Sunset2",4,type="discrete")
col<-pnw_palette("Sunset2",3,type="discrete")
col3<-pnw_palette("Sunset2",8,type="continuous")

col<-pnw_palette("Sunset2",3,type="discrete")
climate_dat <-readRDS(here('data/physical/climate_dat_upwelling.rds'))

bakunsites <- read.csv(here('data/physical/Bakun/MapLocations.csv'))
sites <- st_as_sf(data.frame(bakunsites[,1:2]), coords = c("longitude","latitude"), crs = 4326, 
agr = "constant")


world <- ne_countries(scale='medium',returnclass = 'sf')
class(world)

map <- ggplot(data = world) +
   annotate("rect",xmin = -117, xmax = -157, ymin = 50.5, ymax = 62, 
     fill = col2[1], colour = col2[1], size = 0.8, alpha=0.5) +
  annotate(geom = "text", x = -145, y = 55, label = "Gulf of Alaska", 
     fontface = "italic", color = "grey22", size = 4) +
  
  annotate("rect",xmin = -140, xmax = -115, ymin = 40.4401, ymax = 50.5, 
     fill = col2[2], colour = col2[2], size = 0.8, alpha=0.5) +
  annotate(geom = "text", x = -134, y = 45, 
    label = str_wrap("Northern California  Current", width = 5),
    fontface = "italic", color = "grey22", size = 4) +
   
   annotate("rect", xmin= -140, xmax = -115, ymin = 34.4486, ymax = 40.4401, 
     fill = col2[4], colour = col2[4], size = 0.8, alpha=0.5) +
   annotate(geom = "text", x = -132, y = 37, 
    label = str_wrap("Central California  Current", width = 20),
    fontface = "italic", color = "grey22", size = 3.75) +
  
  annotate("rect", xmin= -140, xmax = -105, ymin = 22.1, ymax = 34.4486, 
     fill = col2[3], colour = col2[3], size = 0.8, alpha=0.5) +
  annotate(geom = "text", x = -129, y = 27, 
    label = str_wrap("Southern California  Current", width = 5),
    fontface = "italic", color = "grey22", size = 4) +
  
  geom_point(x=-160, y = 45,size = 3, shape = 23, col = "black", fill = col3[5])+
  annotate(geom = "text", x = -152, y = 45, 
    label = str_wrap("Bakun Index Location", width = 12),
     color = "grey22", size = 4) +
  geom_sf(fill='grey95') +
  geom_sf(data = sites, size = 2, shape = 23, col = "black", fill = col3[5]) +
     coord_sf(xlim = c(-165, -108), ylim = c(22, 62.5), expand = FALSE)+
   scale_x_continuous(name = "") +
   scale_y_continuous(name = "") +
  theme(panel.background = element_rect(fill = "white"),
     panel.border = element_rect(fill = NA))
map

```

Upwelling trends through time. The annual average model shows evidence of a 1988/1989 change in the California Current that is most pronounced in the south. Spring upwelling model appears to have a 1988/1989 shift. Evidence for another shift are less pronounced. in the Northern CC 2022 actually appears to be anomalous, where it is pulling the the trend down that would normally be positive. 

```{r map2, echo=FALSE}

season_dat <- climate_dat %>% pivot_longer(cols=c('seasonal_ONI', 'seasonal_PDO','seasonal_NPGO'),
                    names_to='Index',
                    values_to='values')

annual_dat <- climate_dat %>% pivot_longer(cols=c('annual_ONI', 'annual_PDO','annual_NPGO'),
                    names_to='Index',
                    values_to='values')

ggplot(data = season_dat%>%filter(season=="Spring"), aes(x = Year_lag, y = values)) +
    facet_wrap(.~Index, ncol = 2, scales='free') +
  geom_line(size=0.75)+
  scale_y_continuous(name = "Spring Index") + 
  scale_x_continuous(name = "Year") + 
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  theme_bw()


ggplot(data = climate_dat%>%filter(season=="Spring"), aes(x = Year_lag, y = stand_bakun_seasonally)) +
    facet_wrap(.~region, ncol = 2, scales='free') +
  geom_line(size=0.75)+
  scale_y_continuous(name = "Annual Average Upwelling \n (Bakun 1˚ 6-hourly)") + 
  scale_x_continuous(name = "Year") + 
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  theme_bw()


ggplot(data = annual_dat, aes(x = Year_lag, y = values)) +
    facet_wrap(.~Index, ncol = 2, scales='free') +
  geom_line(size=0.75)+
  scale_y_continuous(name = "Spring Index") + 
  scale_x_continuous(name = "Year") + 
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  theme_bw()

ggplot(data = climate_dat, aes(x = Year_lag, y = stand_bakun_annual)) +
    facet_wrap(.~region, ncol = 2, scales='free') +
  geom_line(size=0.75)+
  scale_y_continuous(name = "Annual Average Upwelling \n (Bakun 1˚ 6-hourly)") + 
  scale_x_continuous(name = "Year") + 
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  theme_bw()


```



```{r upwelling}
map
```


Run the STAN model outside of markdown file using "STANrun.R" which exports the posteriors so that the model does not run in markdown when you knit.



## STAN Model
Bayesian linear model with era specific intercept and slope and region specific slope,

$$Upwelling = \alpha_{e,r} + \beta_{e,r}*PDO +\sigma$$
where *e* is factor "era" corresponding to eras 1967 - 1988, 1989 - 2013, and 2014 - 2022 and *r* corresponds to regions Southern California Current (south of Mendocino), Northern California Current (Mendocino to Vancouver Island), and Gulf of Alaska (north of Vancover Island).

| Parameter     | Description | Prior     |
| :---        |    :----:   |          ---: |
| $\alpha_{e,r}$      | Era and region specific anomaly      |  $~ Normal(0,10)$   |
| $\beta_{e,r}$   | Upwelling-PDO relationship by era and region        | $~ Normal(0,10)$      |
| $\sigma$   | Combined observation and process error        | $~ Normal(0,10)[0,]$     |


#PDO - Upwelling relationship analyses

## Seasonal Mean Models

These results utilize seasonal averagers rather than monthly means within a season. May be better for identifying trends that are not spuriously seasonal (i.e. changes in a given month) but tradeoff is less data and may miss some interesting dynamics as a result

### Annual Model

```{r seasonalANNUAL, echo=FALSE}
annual <- climate_dat%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_annual,period, era.region,annual_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(annual$period)
NP <- 12
P<- as.numeric(as.factor(annual$era.region))
P2 <-as.numeric(as.factor(annual$region))
K <- 1
x <- data.frame(annual$stand_bakun_annual)
y<-annual$annual_PDO

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

warmups <- 1000
total_iterations <- 3000
max_treedepth <-  10
n_chains <-  3
n_cores <- 4
adapt_delta <- 0.95

bhfit.pdo.annual  <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.pdo.annual.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


posterior<-data.frame(summary(bhfit.pdo.annual.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)

region.lev <-c("GoA", "Northern CC", "Central CC", "Southern CC")
annual$region <-factor(annual$region, levels=region.lev) 
region.lev2 <-c("GoA", "NCC", "CCC", "SCC")


annual$region <- factor(annual$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Plots of the annual average model.

```{r seasonalANNUALplots, echo=FALSE}

ggplot(data = annual, aes(x = stand_bakun_annual, y = annual_PDO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")

```

### Winter Model

Fitting the winter seasonal model

```{r seasonalWINTER, include=FALSE}

winter <- climate_dat%>%filter(season=="Winter")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)


N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
P2<- as.numeric(as.factor(winter$region))
K <- 1
x <- data.frame(winter$stand_bakun_seasonally)
y<-winter$seasonal_PDO

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.pdo.winter <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.pdo.winter.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.pdo.winter.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)
winter$region <-factor(winter$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Plots of the winter seasonal model.

```{r seasonalWINTERplots, echo=FALSE}
ggplot(data = winter, aes(x = stand_bakun_seasonally, y = seasonal_PDO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```

### Spring Model

Fitting the spring seasonal model

```{r seasonalSPRING, include=FALSE}

spring <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(spring$period)
NP <- 12
P<- as.numeric(as.factor(spring$era.region))
P2<- as.numeric(as.factor(spring$region))
K <- 1
x <- data.frame(spring$stand_bakun_seasonally)
y<-spring$seasonal_PDO

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.pdo.spring <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.pdo.spring.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.pdo.spring.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)

spring$region <-factor(spring$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Spring model plots

```{r seasonalSPRINGplots, echo=FALSE}
ggplot(data = spring, aes(x = stand_bakun_seasonally, y =seasonal_PDO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```

Comparing models using an "era" term

```{r pdoLOO, echo=FALSE, include= FALSE}

pdo.annual.era<-loo(extract_log_lik(bhfit.pdo.annual.era, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))
pdo.annual<-loo(extract_log_lik(bhfit.pdo.annual, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))

pdo.annual<-list(pdo.annual.era,pdo.annual)
loo.pdo.annual <- loo_compare(pdo.annual)

pdo.winter.era<-loo(extract_log_lik(bhfit.pdo.winter.era, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))
pdo.winter<-loo(extract_log_lik(bhfit.pdo.winter, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))

pdo.winter<-list(pdo.winter.era,pdo.winter)
loo.pdo.winter <- loo_compare(pdo.winter)


pdo.spring.era<-loo(extract_log_lik(bhfit.pdo.spring.era, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))
pdo.spring<-loo(extract_log_lik(bhfit.pdo.spring, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))

pdo.spring<-list(pdo.spring.era,pdo.spring)
loo.pdo.spring <- loo_compare(pdo.spring)

```

PDO Model Comparison

| Season     | Era Model elpd_diff | Region Model elpd_diff     |
| :---        |    :----:   |          ---: |
| Annual    | 0 (0) |  -434.2 (66.7)   |
| Winter | 0 (0) |-417.4 (68.0)     |
| Spring  | 0 (0)  | -438.7 (71.6)    |


#NPGO

## Seasonal Mean Models

These results utilize seasonal averagers rather than monthly means within a season. May be better for identifying trends that are not spuriously seasonal (i.e. changes in a given month) but tradeoff is less data and may miss some interesting dynamics as a result

### Annual Model

```{r NPGOseasonalANNUAL, include=FALSE}
annual <- climate_dat%>%
  select(Year_lag, region, stand_bakun_seasonally,stand_bakun_annual,period, era.region,annual_NPGO)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(annual$period)
NP <- 12
P<- as.numeric(as.factor(annual$era.region))
P2<- as.numeric(as.factor(annual$region))
K <- 1
x <- data.frame(annual$stand_bakun_annual)
y<-annual$annual_NPGO

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit.npgo.annual <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit.npgo.annual.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.npgo.annual.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)
annual$region <-factor(annual$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Plots of the annual average model.

```{r NPGOANNUALplots, echo=FALSE}
ggplot(data = annual, aes(x = stand_bakun_annual, y = annual_NPGO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```

### Winter Model

Fitting the winter seasonal model

```{r NPGOseasonalWINTER, include=FALSE}

winter <- climate_dat%>%filter(season=="Winter")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_NPGO)%>%
    distinct()%>%
  filter(Year_lag<2023)


N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
P2<- as.numeric(as.factor(winter$region))
K <- 1
x <- data.frame(winter$stand_bakun_seasonally)
y<-winter$seasonal_NPGO

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit.npgo.winter <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit.npgo.winter.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.npgo.winter.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Plots of the winter seasonal model.

```{r NPGOseasonalWINTERplots, echo=FALSE}
ggplot(data = winter, aes(x = stand_bakun_seasonally, y = seasonal_NPGO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```

### Spring Model

Fitting the spring seasonal model

```{r NPGOseasonalSPRING, include=FALSE}

spring <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_NPGO)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(spring$period)
NP <- 12
P<- as.numeric(as.factor(spring$era.region))
P2<- as.numeric(as.factor(spring$region))
K <- 1
x <- data.frame(spring$stand_bakun_seasonally)
y<-spring$seasonal_NPGO

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.npgo.spring <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.npgo.spring.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


posterior<-data.frame(summary(bhfit.npgo.spring.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)

spring$region <-factor(spring$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Spring model plots

```{r NPGOseasonalSPRINGplots, echo=FALSE}
ggplot(data = spring, aes(x = stand_bakun_seasonally, y =seasonal_NPGO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```


Comparing models using an "era" term

```{r npgoLOO, echo=FALSE, include= FALSE}

npgo.annual.era<-loo(extract_log_lik(bhfit.npgo.annual.era, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))
npgo.annual<-loo(extract_log_lik(bhfit.npgo.annual, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))

npgo.annual<-list(npgo.annual.era,npgo.annual)
loo.npgo.annual <- loo_compare(npgo.annual)

npgo.winter.era<-loo(extract_log_lik(bhfit.npgo.winter.era, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))
npgo.winter<-loo(extract_log_lik(bhfit.npgo.winter, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))

npgo.winter<-list(npgo.winter.era,npgo.winter)
loo.npgo.winter <- loo_compare(npgo.winter)


npgo.spring.era<-loo(extract_log_lik(bhfit.npgo.spring.era, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))
npgo.spring<-loo(extract_log_lik(bhfit.npgo.spring, parameter_name = c("alphaP","betaP","sigma"),merge_chains = TRUE))

npgo.spring<-list(npgo.spring.era,npgo.spring)
loo.npgo.spring <- loo_compare(npgo.spring)

```

NPGO Model Comparison

| Season     | Era Model elpd_diff | Region Model elpd_diff     |
| :---        |    :----:   |          ---: |
| Annual    | 0 (0) |  -442.5 (77.8)   |
| Winter | 0 (0) | -420.1 (70.5)     |
| Spring  | 0 (0)  | -16.0 (9.5)    |

## ENSO 

### Winter Model

```{r ONIseasonalANNUAL, include=FALSE}
annual <- climate_dat%>%
  select(Year_lag, region, stand_bakun_seasonally,stand_bakun_annual,period, era.region,annual_ONI)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(annual$period)
NP <- 12
P<- as.numeric(as.factor(annual$era.region))
P2<- as.numeric(as.factor(annual$region))
K <- 1
x <- data.frame(annual$stand_bakun_annual)
y<-annual$annual_ONI

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit.oni.annual <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit.oni.annual.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.oni.annual.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)
annual$region <-factor(annual$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Plots of the annual average model.

```{r ONIANNUALplots, echo=FALSE}
ggplot(data = annual, aes(x = stand_bakun_annual, y = annual_ONI,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```



Fitting the winter seasonal model

```{r seasonalWINTERenso, include=FALSE}

winter <- climate_dat%>%filter(season=="Winter")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_ONI)%>%
    distinct()%>%
  filter(Year_lag<2023)


N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
P2<- as.numeric(as.factor(winter$region))
K <- 1
x <- data.frame(winter$stand_bakun_seasonally)
y<-winter$seasonal_ONI

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.oni.winter <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.oni.winter.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.oni.winter.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)
winter$region <-factor(winter$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Plots of the winter seasonal model.

```{r seasonalWINTERplotsenso, echo=FALSE}
ggplot(data = winter, aes(x = stand_bakun_seasonally, y = seasonal_ONI,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```

### Spring Model

Fitting the spring seasonal model

```{r seasonalSPRINGoni, include=FALSE}

spring <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_ONI)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(spring$period)
NP <- 12
P<- as.numeric(as.factor(spring$era.region))
P2<- as.numeric(as.factor(spring$region))
K <- 1
x <- data.frame(spring$stand_bakun_seasonally)
y<-spring$seasonal_ONI

data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P2, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.oni.spring <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))


data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit.oni.spring.era <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit.oni.spring.era, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)))%>%
  rename(alpha=tempalpha, beta = tempbeta)

spring$region <-factor(spring$region, levels=region.lev) 
scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

```

Spring model plots

```{r seasonalSPRINGplotsenso, echo=FALSE}
ggplot(data = spring, aes(x = stand_bakun_seasonally, y =seasonal_ONI,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")
```



## Questions / Thoughts

To Do: 

1) Examine Upwelling relationships with SLP, SSH, wind stress, and SST
Examine the relationship between SST and the same set of atmospheric variables (PDO, SLP, SSH, wind stress). Would we really expect different relationships with SLP given its reanalyses are what make up Bakun indices?

2) we could also compare these results to results with CUTI and BEUTI that use just the last two periods (CUTI and BEUTI account for more nuanced changes in cross and along shore wind; only data after 1988)

3) *plankton case study* I think that this paper would be more compelling if it had some degree of biology. Maybe we could bring in some of the Zoop CalCofi data as a case study within the larger regional analysis and link these changing relationships to an ecosystem response - it would also be a nice thing to build our way up the food web with the salmon/groundfish part of the project and still take a foodweb wide view that was initially in the proposal. Are there are plankton datasets in the Southern California Current and/or GoA we could use?

4) How should we think/talk about intercepts. To me slopes are more compelling...

## Interpretations
## NPGO

## PDO 
**Winter** across all regions, the 1967 - 1988 period shows the greatest difference in intercept with the 1989 - 2013 period where the most recent heat wave period actually falls between the two however slopes are much more consistent with substantial posterior overlap for all three periods in all regions.

**Spring** strong change in the slope of NCC during spring but less in other regions where it overlaps with the other two eras - this is consistent with both approaches to characterizing season.

The seasonal average model shows more of a difference for the SCC for the most recent heatwave period than the monthly mean model.

**Summer** Summer is pretty consistent in slop and intercept with the exception of the SCC intercept is different for the early and late periods compared to the middle.