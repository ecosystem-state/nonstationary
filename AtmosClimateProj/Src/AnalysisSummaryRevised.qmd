---
title: "Analysis Summary"
format: html
editor: visual
html_document:
    toc: true
---

### Summary Plots

```{r}
#| echo: false
#| warning: false
#| message: false
library(ncdf4)
library(chron)
library(tidyverse)
library(kohonen) # fitting
library(aweSOM) # plotting
library(SOMbrero) # plotting
library(paletteer) #colors
library(PNWColors) #more colors
library(here) #navigating folders
library(dplyr)
library(nord)
library(tidyr)
library(sf)
library(ggplot2)
library(cowplot)
library(Cairo)
library(tidyverse)
library(rstan)
library(maps)       #basic mapping functions and some data
library(mapdata)    #some additional hires data
library(maptools)   #useful tools such as reading shapefiles
library(mapproj)
library(rgdal)
library(colorspace)
library(PBSmapping) 
library(ggpubr) 
set.seed(1234)
here::i_am("som/sst_soms_spring.qmd")
```

```{r map, include=FALSE}

col2<-pnw_palette("Sunset2",4,type="discrete")
col<-pnw_palette("Sunset2",3,type="discrete")
col3<-pnw_palette("Sunset2",8,type="continuous")

col<-pnw_palette("Sunset2",3,type="discrete")
climate_dat <-readRDS(here('data/physical/climate_dat_upwelling.rds'))
climate_dat_cop <-readRDS(here('data/physical/climate_dat_cop.rds'))
bakunsites <- read.csv(here('data/physical/Bakun/MapLocations.csv'))%>%
  mutate(longitude=longitude+360)
sites <- st_as_sf(data.frame(bakunsites[,1:2]), coords = c("longitude","latitude"), crs = 4326, 
agr = "constant")


world <- st_as_sf(map('world2', plot=F, fill=T))

map <- ggplot(data = world) +
   annotate("rect",xmin = -117+360, xmax = -157+360, ymin = 50.5, ymax = 62, 
     fill = col2[1], colour = col2[1], size = 0.8, alpha=0.5) +
  annotate(geom = "text", x = -145+360, y = 55, label = "Gulf of Alaska", 
     fontface = "italic", color = "grey22", size = 4) +
  
  annotate("rect",xmin = -140+360, xmax = -115+360, ymin = 40.4401, ymax = 50.5, 
     fill = col2[2], colour = col2[2], size = 0.8, alpha=0.5) +
  annotate(geom = "text", x = -134+360, y = 45, 
    label = str_wrap("Northern California  Current", width = 5),
    fontface = "italic", color = "grey22", size = 4) +
   
   annotate("rect", xmin= -140+360, xmax = -115+360, ymin = 34.4486, ymax = 40.4401, 
     fill = col2[4], colour = col2[4], size = 0.8, alpha=0.5) +
   annotate(geom = "text", x = -132+360, y = 37, 
    label = str_wrap("Central California  Current", width = 20),
    fontface = "italic", color = "grey22", size = 3.75) +
  
  annotate("rect", xmin= -140+360, xmax = -105+360, ymin = 22.1, ymax = 34.4486, 
     fill = col2[3], colour = col2[3], size = 0.8, alpha=0.5) +
  annotate(geom = "text", x = -129+360, y = 27, 
    label = str_wrap("Southern California  Current", width = 5),
    fontface = "italic", color = "grey22", size = 4) +
  
  geom_point(x=-160+360, y = 45,size = 3, shape = 23, col = "black", fill = col3[5])+
  annotate(geom = "text", x = -152+360, y = 45, 
    label = str_wrap("Bakun Index Location", width = 12),
     color = "grey22", size = 4) +
  geom_sf(fill='grey95') +
  geom_sf(data = sites, size = 2, shape = 23, col = "black", fill = col3[5]) +
     coord_sf(xlim = c(-165+360, -108+360), ylim = c(22, 62.5), expand = FALSE)+
   scale_x_continuous(name = "") +
   scale_y_continuous(name = "") +
  theme(panel.background = element_rect(fill = "white"),
     panel.border = element_rect(fill = NA))
map

```

**Figure 1**: Distribution of upwelling data relative to regional delineations.

```{r upwelling}
map
```

Figures 2 and 3 are purely exploratory to visualize patterns in upwelling and climate indices through time. Linear trends have been added to the temporal data to examine the breakpoints. These would not be a main text figure but may be included in a supplement.

**Figure 2**: Trends in upwelling through time by region. Spring upwelling model appears to have a 1988/1989 shift. Evidence for another shift are less pronounced. in the Northern CC 2022 actually appears to be anomalous, where it is pulling the the trend down that would normally be positive.

```{r uptrend, echo=FALSE}

season_dat <- climate_dat %>% pivot_longer(cols=c('seasonal_ONI', 'seasonal_PDO','seasonal_NPGO', "seasonal_NPH"),
                    names_to='Index',
                    values_to='values')

annual_dat <- climate_dat %>% pivot_longer(cols=c('annual_ONI', 'annual_PDO','annual_NPGO', "annual_NPH"),
                    names_to='Index',
                    values_to='values')

ggplot(data = climate_dat%>%filter(season=="Spring"), aes(x = Year_lag, y = stand_bakun_seasonally)) +
    facet_wrap(.~region, ncol = 2, scales='free') +
  geom_line(size=0.75)+
  scale_y_continuous(name = "Average Spring Upwelling \n (Bakun 1˚ 6-hourly)") + 
  scale_x_continuous(name = "Year") + 
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  theme_bw()


```

**Figure 3**: Trends in climate indices through through time. Evidence for a 1988/1989 PDO shift is not evident in ONI or NPGO. NPGO appear to have a bigger change in the past decade compared to the 1989/1988 shift.

```{r indextrend, echo=FALSE}
ggplot(data = season_dat%>%filter(season=="Winter"), aes(x = Year_lag, y = values)) +
    facet_wrap(.~Index, ncol = 2, scales='free') +
  geom_line(size=0.75)+
  scale_y_continuous(name = "Spring Index") + 
  scale_x_continuous(name = "Year") + 
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  theme_bw()
```

```{r loaddatacorr}
#| echo: false
#| warning: false
#| message: false
# start by loading output for correlation summary
correlation <-readRDS(here('data/physical/correlation_analysis.rds'))
correlation2 <-readRDS(here('data/physical/correlation_analysis_indices.rds'))
correlationdiff <-readRDS(here('data/physical/correlation_analysis_diff.rds'))


col<-pnw_palette("Sunset2",3,type="discrete")

```

### Upwelling and Environmental Forcing

#### Objective 2

**Objective 2**: Evaluate evidence for SST/SLP - climate indices.

**Approach** This section includes regression analysis to identify changes in the relationships between SST and SLP with regional climate indices. We apply linear models with time periods treated as factors (1967 - 1988; 1989 - 2013; 2013 - 2022) examining regional differences (Figure 1) in associations.

**Summary** The slope of the relationship between SST and climate indices is relaatively consistent through time. There is some change in the relationship with NPGO specifically during the 2013 - 2021 period particularly along the CCC and SCC coast. There is greater variability in the relationship (slope) between climate indices and SLP. There is a reversal of the relationship between climate indices and SLP from 1989 - 2012 and 2013 - 2022, this shift in the slope is particularly pronounced in the Northern California Current and PDO and ONI.

```{r sstcorrplot,fig.height = 11, fig.width =11}
#| echo: false
#| warning: false
#| message: false
#| include: false

sst_cor <- correlation%>%
  filter(var=="SST")
ggplot() + 
  geom_sf(data=world, col="black", fill="darkgoldenrod3") +
  coord_sf(xlim=c(120,240), ylim=c(0,60)) +
  geom_raster(data=sst_cor, aes(x=longitude,y=latitude,fill = coefficient)) + 
  facet_wrap(~analysis, ncol = 3) + 
  scale_fill_gradient2(low = "blue", high = "red") + 
  ggtitle("Spring SST Anomalies vs. Spring Regional Upwelling")+
  #geom_contour(data=X_cc, aes(x=longitude,y=latitude,z = coefficient), col="lightgrey", lwd=0.5)+
  theme(panel.background = element_rect(fill = "white"),plot.title = element_text(hjust = 0.5), panel.border = element_rect(fill = NA)) 
 

```

```{r slpcorrplot, fig.height = 11, fig.width =11}
#| echo: false
#| warning: false
#| message: false
#| include: false

slp_cor <- correlation%>%
  filter(var=="SLP")


ggplot() + 
  geom_raster(data=slp_cor, aes(x=longitude,y=latitude,fill = coefficient)) + 
  facet_wrap(~analysis, ncol = 3) + 
   geom_sf(data=world, col="black", fill="darkgoldenrod3") +
  coord_sf(xlim=c(120,240), ylim=c(0,60)) +
  scale_fill_gradient2(low = "blue", high = "red") + 
  ggtitle("Spring SLP Anomalies vs. Spring Regional Upwelling")+
  #geom_contour(data=X_cc, aes(x=longitude,y=latitude,z = coefficient), col="lightgrey", lwd=0.5)+
  theme(panel.background = element_rect(fill = "white"),plot.title = element_text(hjust = 0.5), panel.border = element_rect(fill = NA)) 
 

```

**Figure 4**: Linear regression (slope) between climate indices (PDO, ONI, NPH, NPGO) and sea level pressure. These correlations are based on three time periods: 1967-1988, 1989 - 2012, 2013 - 2022. 1988 marks a shift in Aleutian low variability, and increase in Winter SLP anomaly, and a change in the correlation between PDO - NPGO (see Litzow et al. 2020 PNAS).

```{r slpcorrindex, fig.height = 11, fig.width =11}
#| echo: false
#| warning: false
#| message: false

slp_cor2 <- correlation2%>%
  filter(var=="SLP")


ggplot() + 
  geom_raster(data=slp_cor2, aes(x=longitude,y=latitude,fill = coefficient)) + 
  facet_wrap(~analysis, ncol = 3) + 
  geom_sf(data=world, col="black", fill="darkgoldenrod3") +
  coord_sf(xlim=c(190,240), ylim=c(30,60)) +
  scale_fill_gradient2(low = "blue", high = "red") + 
  ggtitle("SLP")+
  #geom_contour(data=X_cc, aes(x=longitude,y=latitude,z = coefficient), col="lightgrey", lwd=0.5)+
  theme(panel.background = element_rect(fill = "white"),plot.title = element_text(hjust = 0.5), panel.border = element_rect(fill = NA)) 

```

```{r slpcorrdiff, fig.height = 11, fig.width =11}
#| echo: false
#| warning: false
#| message: false

slp_cordiff <- correlationdiff%>%
  filter(var=="SLP")


ggplot() + 
  geom_raster(data=slp_cordiff, aes(x=longitude,y=latitude,fill = coefficient)) + 
  facet_wrap(~analysis, ncol = 3) + 
  geom_sf(data=world, col="black", fill="darkgoldenrod3") +
  coord_sf(xlim=c(190,240), ylim=c(30,60)) +
  scale_fill_gradient2(low = "blue", high = "red") + 
  ggtitle("SLP Difference")+
  #geom_contour(data=X_cc, aes(x=longitude,y=latitude,z = coefficient), col="lightgrey", lwd=0.5)+
  theme(panel.background = element_rect(fill = "white"),plot.title = element_text(hjust = 0.5), panel.border = element_rect(fill = NA)) 

```

**Figure 5**: Linear regression (slope) between climate indices (PDO, ONI, NPH, NPGO) and sea surface temperature. These correlations are based on three time periods: 1967-1988, 1989 - 2012, 2013 - 2022. 1988 marks a shift in Aleutian low variability, and increase in Winter SST anomaly, and a change in the correlation between PDO - NPGO (see Litzow et al. 2020 PNAS).

```{r sstcorrindex, fig.height = 11, fig.width =11}
#| echo: false
#| warning: false
#| message: false

sst_cor2 <- correlation2%>%
  filter(var=="SST")


ggplot() + 
  geom_raster(data=sst_cor2, aes(x=longitude,y=latitude,fill = coefficient)) + 
  facet_wrap(~analysis, ncol = 3) + 
  geom_sf(data=world, col="black", fill="darkgoldenrod3") +
  coord_sf(xlim=c(190,240), ylim=c(30,60)) +
  scale_fill_gradient2(low = "blue", high = "red") + 
  ggtitle("SST")+
  #geom_contour(data=X_cc, aes(x=longitude,y=latitude,z = coefficient), col="lightgrey", lwd=0.5)+
  theme(panel.background = element_rect(fill = "white"),plot.title = element_text(hjust = 0.5), panel.border = element_rect(fill = NA)) 

```

```{r sstcorrdiff, fig.height = 11, fig.width =11}
#| echo: false
#| warning: false
#| message: false

sst_cordiff <- correlationdiff%>%
  filter(var=="SST")


ggplot() + 
  geom_raster(data=sst_cordiff, aes(x=longitude,y=latitude,fill = coefficient)) + 
  facet_wrap(~analysis, ncol = 3) + 
  geom_sf(data=world, col="black", fill="darkgoldenrod3") +
  coord_sf(xlim=c(190,240), ylim=c(30,60)) +
  scale_fill_gradient2(low = "blue", high = "red") + 
  ggtitle("SST Difference")+
  #geom_contour(data=X_cc, aes(x=longitude,y=latitude,z = coefficient), col="lightgrey", lwd=0.5)+
  theme(panel.background = element_rect(fill = "white"),plot.title = element_text(hjust = 0.5), panel.border = element_rect(fill = NA)) 

```

### Upwelling and Climate Indices

#### Objective 3

**Objective 3**: Identify decoupling between climate indices and ecologically relevant physical conditions by assessing the relationship between upwelling and basin scale climate indices (PDO, NPGO, ENSO, NPI) during the marine heatwave era

**Approach**: Bayesian linear model with region-level factors (GoA, NCC, CCC, SCC) delineated based on Figure 1 using temporal factors for 1967 - 1988; 1989 - 2013; 2014 - 2023.

**Summary**: *PDO*: PDO tends to be most associated with vertical transport and isopycnal depth in the NCC. It is also associated with source depth and density in the NCC and CCC (Figure 17). Generally, PDO is negatively associated with upwelling. Historically, we find evidence of this negative relationship historically across all of the California Current (Figure 13b) but we find a dramatic change in the relationship between upwelling and both PDO/ONI in the NCC during the MHW era (Figure 13) where the the correlation switches from negative to positive. We do not find evidence for a MHW change in the other regions for PDO or ONI. This finding is in agreement with the correlation analysis, where we find a complete reversal of the slope coefficients between NCC upwelling and SST in the MHW era compared to the earlier periods (Figure 11).

*NPGO*: NPGO is positively associated with upwelling and is more associated with vertical transport in the SCC and source depth in the SCC and NCC (Figure 17). We find the relationship between upwelling and NPGO was similar during MHW era and the historic era (1967 - 1988) and did not differ substantially from 0 (weakly negative slope; Figure 13) indicating NPGO-upwelling not closely coupled during this period. However, the relationship was strongly coupled with a positive slope during the 1989 - 2013 period. Notably, NPGO values have been exceptionally negative during the MHW era - including the 3 most negative observations - resulting in a change in the intercept of the relationship. This is consistent across regions and indicates a change in mean values of NPGO.

*ENSO*: The relationship between ENSO-upwelling is similar to that of PDO-upwelling. Specifically, we find a consistent, negative relationship in the California Current, with a strengthening of that relationship in SCC and CCC consistent with the correlation analysis results. Similar to PDO, we find a reversal of the slope coefficient during the MHW era from negative to positive in NCC.

*NPH*: we do not find any strong relationships between NPI-upwelling. Generally, the posteriors for both intercept and slope overlap substantially across eras and regions

```{r PDO, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
K <- 1
y <-winter$stand_bakun_seasonally
x<-data.frame(winter$seasonal_PDO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

warmups <- 1000
total_iterations <- 3000
max_treedepth <-  10
n_chains <-  3
n_cores <- 4
adapt_delta <- 0.95

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.pdo<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)), Index = rep("PDO", 12000))%>%
  rename(alpha=tempalpha, beta = tempbeta)
#ci(scaled.anomaly.pdo, ci=0.8 )
region.lev <-c("GoA", "Northern CC", "Central CC", "Southern CC")
winter$region <-factor(winter$region, levels=region.lev) 
region.lev2 <-c("GoA", "NCC", "CCC", "SCC")
scaled.anomaly.pdo$region <-factor(scaled.anomaly.pdo$region, levels=region.lev2) 

ggplot(data = winter, aes(y = stand_bakun_seasonally,x =seasonal_PDO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.pdo, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.pdo, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly.pdo, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
  facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r NPGO, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_NPGO)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
K <- 1
y <- winter$stand_bakun_seasonally
x<-data.frame(winter$seasonal_NPGO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

warmups <- 1000
total_iterations <- 3000
max_treedepth <-  10
n_chains <-  3
n_cores <- 4
adapt_delta <- 0.95

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.npgo<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)), Index = rep("NPGO",12000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 
scaled.anomaly.npgo$region <-factor(scaled.anomaly.npgo$region, levels=region.lev2) 

ggplot(data = winter, aes(y = stand_bakun_seasonally, x =seasonal_NPGO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.npgo, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.npgo, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.npgo, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
  facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")
```

```{r ENSO, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_ONI)%>%
    distinct()%>%
  filter(Year_lag<2023)

N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
K <- 1
y <- winter$stand_bakun_seasonally
x<-data.frame(winter$seasonal_ONI)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

warmups <- 1000
total_iterations <- 3000
max_treedepth <-  10
n_chains <-  3
n_cores <- 4
adapt_delta <- 0.95

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.oni<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)), Index=rep("ONI", 12000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 
scaled.anomaly.oni$region <-factor(scaled.anomaly.oni$region, levels=region.lev2) 

ggplot(data = winter, aes(y = stand_bakun_seasonally, x =seasonal_ONI,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()


ggplot(scaled.anomaly.oni, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.oni, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.oni, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
  facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")
```

```{r NPI, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, region, season, seasonal_mean, stand_bakun_seasonally,stand_bakun_annual,period, era.region,seasonal_NPH)%>%
    distinct()%>%
  filter(Year_lag<2023)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(winter$period)
NP <- 12
P<- as.numeric(as.factor(winter$era.region))
K <- 1
y <- winter$stand_bakun_seasonally
x<-data.frame(winter$seasonal_NPH)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

warmups <- 1000
total_iterations <- 3000
max_treedepth <-  10
n_chains <-  3
n_cores <- 4
adapt_delta <- 0.95

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:12,]%>%
  add_column(region = rep(c("GoA", "NCC", "CCC","SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))

betaP<-posterior[13:24,]%>%
  add_column(region = rep(c("GoA", "NCC","CCC", "SCC"),each =3), 
             period=rep(c("1967 - 1988","1989 - 2013","2014 - 2022"),4))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.nph<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1967 - 1988', '1989 - 2013', '2014 - 2022'), each = 1000),4),
            region = rep(rep(c("GoA", "NCC","CCC", "SCC"),each = 3000)), Index=rep("NPH", 12000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 
scaled.anomaly.nph$region <-factor(scaled.anomaly.nph$region, levels=region.lev2) 


ggplot(data = winter, aes(y = stand_bakun_seasonally, x =seasonal_NPH,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.nph, aes(x = beta, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.nph, aes(x = alpha, fill = period)) +
  theme_bw() +
  facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")

ggplot(scaled.anomaly.nph, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
  facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")
```

**Figure 6**: Trends in climate indices through through time. Evidence for a 1988/1989 PDO shift is not evident in ONI or NPGO. NPGO appear to have a bigger change in the past decade compared to the 1989/1988 shift.

```{r fullplot, fig.height = 10, fig.width =10}
#| echo: false
#| warning: false
#| message: false

scaled.anomaly <- rbind(scaled.anomaly.nph, scaled.anomaly.pdo, scaled.anomaly.oni, scaled.anomaly.npgo)

scaled.anomaly$region <-factor(scaled.anomaly$region, levels=region.lev2) 

ggplot(scaled.anomaly, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
  facet_grid(Index~region, scales='free') +
  scale_fill_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1], col[2], col[3]),  labels=c("1967-1988", "1989-2013", "2014-2022")) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")


clim<- climate_dat%>%filter(season=="Spring")%>%
  select(Year_lag, period,region, season, stand_bakun_seasonally,seasonal_NPH,seasonal_NPGO,seasonal_PDO,seasonal_ONI)%>%
  rename(NPH=seasonal_NPH,NPGO=seasonal_NPGO,PDO=seasonal_PDO,ONI=seasonal_ONI)%>%
  distinct()%>%
  filter(Year_lag<2023)%>%
  pivot_longer(!c(Year_lag, period, region, season, stand_bakun_seasonally), names_to = "Index_Name", values_to = "Index_Value")

region.lev3 <-c("GoA","Northern CC", "Central CC", "Southern CC")
clim$region <-factor(clim$region, levels=region.lev3) 

ggplot(data = clim, aes(y = stand_bakun_seasonally, x =Index_Value,col=period)) +
  facet_grid(Index_Name~region, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  ggtitle("Spring")

clim<- climate_dat%>%filter(season=="Winter")%>%
  select(Year_lag, period,region, season, stand_bakun_seasonally,seasonal_NPH,seasonal_NPGO,seasonal_PDO,seasonal_ONI)%>%
  rename(NPH=seasonal_NPH,NPGO=seasonal_NPGO,PDO=seasonal_PDO,ONI=seasonal_ONI)%>%
  distinct()%>%
  filter(Year_lag<2023)%>%
  pivot_longer(!c(Year_lag, period, region, season, stand_bakun_seasonally), names_to = "Index_Name", values_to = "Index_Value")

clim$region <-factor(clim$region, levels=region.lev3) 

ggplot(data = clim, aes(y = stand_bakun_seasonally, x =Index_Value,col=period)) +
  facet_grid(Index_Name~region, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Upwelling (Bakun 1˚ 6-hourly)") +
  scale_color_manual(values =  col[1:3], labels=c('1967 - 1988', '1989 - 2013', '2014 - 2022'))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  ggtitle("Winter")
```

### Copepod and Climate Indices

#### Objective 4

**Objective 4**: Identify whether decoupling between climate indices and physical conditions is reflected in the biology (copepods) of the NCC.

**Approach**: Bayesian linear model with temporal factors for 1996 - 2013; 2014 - 2023.

**Summary**: We find that the mean shift in NPGO has altered the relationship between NPGO-copepod abundance in the NCC. This change is reflected in both northern and southern copepod abundance although the magnitude and direction of the changing relationship is different across grouping. During the 1996 - 2013 era, southern copepod biomass is positively associated with NPGO but this relationship weakens and becomes slightly negative during the marine heat wave era. During the 1996 - 2013 era, northern copepod biomass was negatively associated with NPGO but this relationship did not differ from 0 during the marine heat wave era. In addtion, the intercept became negative for both groups.

We do not see a change in the relationship between copepods in the NCC and PDO/ENSO. This may be because: - the GoA and CC did not experience changes in PDO/ENSO relationships with physical forcing mechanisms (SST/SLP; Figure 4 & 5) and ocean conditions (upwelling; Figure 6) like the NCC. If the copepod abundance reflects biomass transported from other areas, we would expect it to primarily reflect changing conditions in 1) phisical- climate index relationships in the areas they are being transported from and 2) mechanisms of transport. The change in the relationships between NPGO, physical forcing mechanisms (SST/SLP), and ocean conditions (upwelling) during the marine heat wave era was observed across all regions unlike PDO/ENSO.

##### Northern Copepod and Climate Indices

```{r copNpdo, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
climpdo <- climate_dat_cop%>%filter(season=="Spring")%>%
  select(Year_lag, region,period,  seasonal_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)

coppdo <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, period,seasonal_copepod_northern, annual_copepod_northern)%>%
    distinct()%>%
  filter(Year_lag<2023)%>%
  left_join(climpdo)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(coppdo$period)
NP <- 2
P<- as.numeric(as.factor(coppdo$period))
K <- 1
y <- coppdo$seasonal_copepod_northern
x<-data.frame(coppdo$seasonal_PDO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.pdo<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("PDO", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

coppdo$region <-factor(coppdo$region, levels=region.lev) 


ggplot(data = coppdo, aes(y = seasonal_copepod_northern, x =seasonal_PDO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.pdo, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.pdo, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.pdo, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r copNoni, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
climpdo <- climate_dat_cop%>%filter(season=="Spring")%>%
  select(Year_lag, region,period,  seasonal_ONI)%>%
    distinct()%>%
  filter(Year_lag<2023)

coponi <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, period,seasonal_copepod_northern, annual_copepod_northern)%>%
    distinct()%>%
  filter(Year_lag<2023)%>%
  left_join(climpdo)


#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(coponi$period)
NP <- 2
P<- as.numeric(as.factor(coponi$period))
K <- 1
y <- coponi$seasonal_copepod_northern
x<-data.frame(coponi$seasonal_ONI)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.ONI<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("ONI", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

coponi$region <-factor(coponi$region, levels=region.lev) 


ggplot(data = coponi, aes(y = seasonal_copepod_northern, x =seasonal_ONI,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.ONI, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.ONI, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.ONI, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r copNNPH, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
climpdo <- climate_dat_cop%>%filter(season=="Spring")%>%
  select(Year_lag, region,period,  seasonal_NPH)%>%
    distinct()%>%
  filter(Year_lag<2023)

copnph <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, period,seasonal_copepod_northern, annual_copepod_northern)%>%
    distinct()%>%
  filter(Year_lag<2023)%>%
  left_join(climpdo)


#count(copnph%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(copnph$period)
NP <- 2
P<- as.numeric(as.factor(copnph$period))
K <- 1
y <- copnph$seasonal_copepod_northern
x<-data.frame(copnph$seasonal_NPH)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.NPH<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("NPH", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

copnph$region <-factor(copnph$region, levels=region.lev) 


ggplot(data = copnph, aes(y = seasonal_copepod_northern, x =seasonal_NPH,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.NPH, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.NPH, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.NPH, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r copNNPGO, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, season, seasonal_copepod_northern, annual_copepod_northern,period, seasonal_NPGO)%>%
    distinct()%>%
  filter(Year_lag<2023)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(winter$period)
NP <- 2
P<- as.numeric(as.factor(winter$period))
K <- 1
y <- winter$seasonal_copepod_northern
x<-data.frame(winter$seasonal_NPGO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.NPGO<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("NPGO", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 


ggplot(data = winter, aes(y = seasonal_copepod_northern, x =seasonal_NPGO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.NPGO, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.NPGO, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.NPGO, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

scaled.anomaly.ncop <- rbind(scaled.anomaly.NPH, scaled.anomaly.pdo, scaled.anomaly.ONI, scaled.anomaly.NPGO)%>%
  add_column(Copepod="Northern Copepod")
```

##### Southern Copepod and Climate Indices

```{r copSpdo, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, season, seasonal_copepod_southern, annual_copepod_northern,period, seasonal_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(winter$period)
NP <- 2
P<- as.numeric(as.factor(winter$period))
K <- 1
y <-winter$seasonal_copepod_southern
x<- data.frame(winter$seasonal_PDO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.pdo<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("PDO", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 


ggplot(data = winter, aes(y = seasonal_copepod_southern, x =seasonal_PDO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Southern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.pdo, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.pdo, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.pdo, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r copSoni, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, season, seasonal_copepod_southern, annual_copepod_southern,period, seasonal_ONI)%>%
    distinct()%>%
  filter(Year_lag<2023)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(winter$period)
NP <- 2
P<- as.numeric(as.factor(winter$period))
K <- 1
y <- winter$seasonal_copepod_southern
x<-data.frame(winter$seasonal_ONI)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.ONI<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("ONI", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 


ggplot(data = winter, aes(y = seasonal_copepod_southern, x =seasonal_ONI,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.ONI, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.ONI, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.ONI, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r copSNPGO, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
winter <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, season, seasonal_copepod_southern, annual_copepod_southern,period, seasonal_NPGO)%>%
    distinct()%>%
  filter(Year_lag<2023)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(winter$period)
NP <- 2
P<- as.numeric(as.factor(winter$period))
K <- 1
y <- winter$seasonal_copepod_southern
x<-data.frame(winter$seasonal_NPGO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.NPGO<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("NPGO", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 


ggplot(data = winter, aes(y = seasonal_copepod_southern, x =seasonal_NPGO,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.NPGO, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.NPGO, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.NPGO, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r copSNPH, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false

winter <- climate_dat_cop%>%filter(season=="Summer")%>%
  select(Year_lag, region, season, seasonal_copepod_southern, annual_copepod_northern,period, seasonal_NPH)%>%
    distinct()%>%
  filter(Year_lag<2023)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(winter$period)
NP <- 2
P<- as.numeric(as.factor(winter$period))
K <- 1
y <- winter$seasonal_copepod_southern
x<-data.frame(winter$seasonal_NPH)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:2,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))

betaP<-posterior[3:4,]%>%
  add_column(
             period=rep(c("1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.NPH<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c('1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("NPH", 2000))%>%
  rename(alpha=tempalpha, beta = tempbeta)

winter$region <-factor(winter$region, levels=region.lev) 

ggplot(data = winter, aes(y = seasonal_copepod_southern, x =seasonal_NPH,col=period)) +
    facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.NPH, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.NPH, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]), labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.NPH, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c( "1996-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

scaled.anomaly.scop <- rbind(scaled.anomaly.NPH, scaled.anomaly.pdo, scaled.anomaly.ONI, scaled.anomaly.NPGO)%>%
  add_column(Copepod="Southern Copepod" )
```

```{r fullplotNcop, fig.height = 10, fig.width =8}
#| echo: false
#| warning: false
#| message: false

scaled.anomaly.cop <- rbind(scaled.anomaly.scop, scaled.anomaly.ncop)

ggplot(scaled.anomaly.cop, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
  facet_grid(Index~Copepod, scales='free') +
  scale_fill_manual(values = c(col[2], col[3]),  labels=c("1996-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[2], col[3]),  labels=c("1996-2013", "2014-2022")) +
 # geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")


cop<- climate_dat_cop%>%filter(season=="Spring")%>%
  select(Year_lag, period, season, seasonal_copepod_southern,seasonal_copepod_northern, seasonal_NPH,seasonal_NPGO,seasonal_PDO,seasonal_ONI)%>%
  rename(NPH=seasonal_NPH,NPGO=seasonal_NPGO,PDO=seasonal_PDO,ONI=seasonal_ONI)%>%
  distinct()%>%
  filter(Year_lag<2023)%>%
  pivot_longer(!c(Year_lag, period, season, seasonal_copepod_southern,seasonal_copepod_northern), names_to = "Index_Name", values_to = "Index_Value")%>%
  pivot_longer(c(seasonal_copepod_southern,seasonal_copepod_northern), names_to = "Copepod", values_to = "BiomassAnomaly")

ggplot(data = cop, aes(y = BiomassAnomaly, x =Index_Value,col=period)) +
  facet_grid(Index_Name~Copepod, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  ggtitle("Spring")

cop<- climate_dat_cop%>%filter(season=="Winter")%>%
  select(Year_lag, period, season, seasonal_copepod_southern,seasonal_copepod_northern, seasonal_NPH,seasonal_NPGO,seasonal_PDO,seasonal_ONI)%>%
  rename(NPH=seasonal_NPH,NPGO=seasonal_NPGO,PDO=seasonal_PDO,ONI=seasonal_ONI)%>%
  distinct()%>%
  filter(Year_lag<2023)%>%
  pivot_longer(!c(Year_lag, period, season, seasonal_copepod_southern,seasonal_copepod_northern), names_to = "Index_Name", values_to = "Index_Value")%>%
  pivot_longer(c(seasonal_copepod_southern,seasonal_copepod_northern), names_to = "Copepod", values_to = "BiomassAnomaly")

ggplot(data = cop, aes(x = BiomassAnomaly, y =Index_Value,col=period)) +
  facet_grid(Index_Name~Copepod, scales='free') +
  geom_point(size=0.75,aes(col=period)) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_x_continuous(name = "Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[2:3], labels=c('1996 - 2013', '2014 - 2022'))+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+
  ggtitle("Winter")

```

```{r rreaspdo, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
dfa<-readRDS(here('data/physical/climate_dat_dfa.rds'))%>%rename(period=era)

pdo <- dfa%>%filter(season=="Spring")%>%
  select(Year_lag,period, season, seasonal_PDO)%>%
    distinct()%>%
  filter(Year_lag<2023)

dfapdo <- dfa%>%filter(trend=="RREAS")%>%
  select(Year_lag, period,estimate)%>%
    distinct()%>%
  filter(Year_lag<2023)%>%
  left_join(pdo)

#count(winter%>%filter(region=='GoA')$seasonal_NPH==0)

N <- length(dfapdo$period)
NP <- 3
P<- as.numeric(as.factor(dfapdo$period))
K <- 1
y <- dfapdo$estimate
x<-data.frame(dfapdo$seasonal_PDO)
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)


bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))

posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:3,]%>%
  add_column(
             period=rep(c("1983 - 1988","1989 - 2013","2014 - 2022"),1))

betaP<-posterior[4:6,]%>%
  add_column(
             period=rep(c("1983 - 1988","1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.pdo<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c("1983 - 1988",'1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("PDO", 3000))%>%
  rename(alpha=tempalpha, beta = tempbeta)


ggplot(data = dfapdo, aes(y = estimate, x =seasonal_PDO,col=period)) +
    #facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=as.factor(period))) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[1:3], labels=c("1983 - 1988",'1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.pdo, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.pdo, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1],col[2], col[3]), labels=c("1967-1988",  "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.pdo, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1],col[2], col[3]),  labels=c("1983-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1],col[2], col[3]),  labels=c("1983-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```

```{r rreaspdo, fig.height = 2.5, fig.width =7}
#| echo: false
#| warning: false
#| message: false
#| include: false
dfa<-readRDS(here('data/physical/climate_dat_dfa.rds'))%>%rename(period=era)

dat <- dfa%>%filter(season=="Spring", trend=="CALCOFI")%>%
    distinct()%>%
  filter(Year_lag<2023)

bayeslinmod(dfa, which(colnames(dat) == "seasonal_PDO"),  which(colnames(dat) == "estimate"))

bayeslinmod <- function(dat, index,trend) { 
  scaled.anomaly <- NULL
N <- length(dat$period)
NP <- 3
P<- as.numeric(as.factor(dat$period))
K <- 1
y <- dat[trend]
x<-dat[index]
data <- list(N = N, #total number of opservations
             NP=NP, #total number of time periods
             P = P, #time period pointer vector
             K = K,#number of covariates, starting with one but can add for final model structure
             x=x, #Upwelling
             y=y #response variable
)

bhfit <- stan(
  file = here::here("Src/BayesianLinearHierarchicalModels.stan"),
  data = data,
  chains = n_chains,
  warmup = warmups,
  iter = total_iterations,
  cores = n_cores,
  refresh = 250,
  control = list(max_treedepth = max_treedepth,
                 adapt_delta = adapt_delta))
      
}











posterior<-data.frame(summary(bhfit, prob=c(0.025, 0.25,0.75, 0.975, 0.1, 0.9))$summary)

alphaP<-posterior[1:3,]%>%
  add_column(
             period=rep(c("1983 - 1988","1989 - 2013","2014 - 2022"),1))

betaP<-posterior[4:6,]%>%
  add_column(
             period=rep(c("1983 - 1988","1989 - 2013","2014 - 2022"),1))
n<- 1000
scaled.anomaly <- NULL
for(i in 1:NP){
tempalpha <- rnorm(n, alphaP$mean[i],alphaP$sd[i])
tempbeta <- rnorm(n, betaP$mean[i],betaP$sd[i])
scaled.anomaly <-rbind(scaled.anomaly,cbind(tempalpha, tempbeta))
}

scaled.anomaly.pdo<- scaled.anomaly%>%
  bind_cols(period=rep(rep(c("1983 - 1988",'1989 - 2013', '2014 - 2022'), each = 1000),1), Index=rep("PDO", 3000))%>%
  rename(alpha=tempalpha, beta = tempbeta)


ggplot(data = dfapdo, aes(y = estimate, x =seasonal_PDO,col=period)) +
    #facet_wrap(.~region, ncol = 4, scales='free') +
  geom_point(size=0.75,aes(col=as.factor(period))) +
  geom_smooth(method = "lm", se = FALSE, aes(col=as.factor(period))) +
  scale_y_continuous(name = "Northern Copepod Biomass Anomaly") +
  scale_color_manual(values =  col[1:3], labels=c("1983 - 1988",'1989 - 2013', '2014 - 2022'))+
  theme_bw()

ggplot(scaled.anomaly.pdo, aes(x = beta, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1], col[2], col[3]), labels=c("1967-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Slope",
       y = "Posterior density")

ggplot(scaled.anomaly.pdo, aes(x = alpha, fill = period)) +
  theme_bw() +
 # facet_wrap(.~region, ncol = 4, scales='free') +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1],col[2], col[3]), labels=c("1967-1988",  "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  geom_vline(xintercept = 0, lty = 2) +
  labs(x = "Intercept (scaled anomaly)",
       y = "Posterior density")


ggplot(scaled.anomaly.pdo, aes(y = beta, x=alpha,fill = period,colour = period)) +
  theme_bw() +
  stat_ellipse(geom = "polygon",alpha=0.4)+
  stat_ellipse(size=1.5)+
 # facet_wrap(.~region, ncol = 4) +
 # geom_density(alpha = 0.7) +
  scale_fill_manual(values = c(col[1],col[2], col[3]),  labels=c("1983-1988", "1989-2013", "2014-2022")) +
  scale_colour_manual(values = c(col[1],col[2], col[3]),  labels=c("1983-1988", "1989-2013", "2014-2022")) +
  #theme(legend.title = element_blank(), legend.position = 'top', legend.key.size = unit(3, 'mm')) +
  #geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(x = "Intercept",y = "Slope")

```
